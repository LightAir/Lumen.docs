# Аутентификация

- [Введение](#introduction)
- [Конфигурация](#configuration)
- [Основы](#basic-usage)

<a name="introduction"></a>
## Введение

Lumen в первую очередь предназначен для построения быстрых микросервисов и API, однако если вы хотите, можете использовать аутентификацию Laravel для проверки подлинности пользователей.

<a name="configuration"></a>
## Конфигурация

> **Примечание:** Для использования аутентификации необходимо включить сессии. Вы можите сделать это раскомментировав middleware `$app->middleware` в файле `bootstrap/app.php`.

Аутентификация имеет несколько настроек которые можно установить в файле `.env`:

> **Примечание:** Не забудьте так же расскомментировать строчку `Dotenv::load(__DIR__.'/../');` в файле `bootstrap/app.php` для того, что бы Lumen подхватил файл `.env`.

- `AUTH_DRIVER`
- `AUTH_MODEL`
- `AUTH_TABLE`

`AUTH_DRIVER` опция определяет какой драйвер аутентификации будет использован. Если `eloquent` то будет использоваться драйвер на базе "Eloquent", если `database` то соответственно будет использоваться "database" драйвер который работает через обычный конструктор запросов.

`AUTH_MODEL` опция определяет имя Eloquent модели которая будет использоваться для аутентификации. Эта модель должна реализовывать контракт `Illuminate\Contracts\Auth\Authenticatable`. В качестве примера посмотрите модель `App\User`, которая по умолчанию включена в Laravel.

`AUTH_TABLE` опция определяет, какая таблица базы данных содержит пользователей. Конечно, данный вариант применяется только в случае использования `database` в качестве драйвера аутентификации.

<a name="basic-usage"></a>
## Основы

В отличие от Laravel, Lumen не включает в себя scaffolding для проверки подлинности, так что вам нужно будет использовать библиотеки аутентификации вручную.

> **Примечание:** Если вы собираетесь использовать `Auth` фасад, то сначала убедитесь, что расскомментировали строчку `$app->withFacades()` в файле `bootstrap/app.php`.

Во первых давайте попробуем использовать метод `attempt`:

```php
	use Illuminate\Http\Request;

	$app->post('auth/login', function(Request $request) {

		if (Auth::attempt($request->only('email', 'password'))) {
			return redirect('dashboard');
		}

	});
```

Метод `attempt` принимает массив пар "ключ-значение" в качестве первого аргумента. Значение ключа `password` будет  [хэшировано](/docs/hashing). Другие значения в массиве будут использованы для того что бы найти пользователя в таблице базы данных. В примере выше пользователь будет выбираться по `email`. Если пользователь найден, то хэшированный пароль будет сравниваться с хэшированным значением `password` переданного методу через массив. Если хэши совпали то стартует авторизованная сессия для пользователя, проще говоря пользователь будет залогинен.

Метод `attempt` возвращает `true` если аутентификация успешна. Иначе возвратит `false`.

> **Примечание:** в этом примере, `email` не является обязательным, он выбран в качестве примера. Вы должны использовать название той колонки, по которой собираетесь аутентифицировать пользователя, как правило это "username".

#### Аутентификация пользователя с условием

Вы так же можете добавить дополнительные условия аутентификации:

	if (Auth::attempt(['email' => $email, 'password' => $password, 'active' => 1]))	{
		// Пользователь будет аутентифицирован если он активен, не приостановлен, и существует
	}

#### Проверка, аутентифицирован ли пользователь

Для проверки аутентифицирован ли пользователь вы можете использовать метод `check`:

	if (Auth::check()) {
		// Пользователь зарегистрирован ...
	}

#### Аутентификация и «запоминание» пользователя

Ели вы хотите предоставить пользователю возможность использовать функционал "Помнить меня" вы можете передать булево значение в качестве второго аргументом в метод `attempt`, что позволит запомнить пользователя навсегда, до тех пор пока он сам не выйдет из приложения. Конечно же ваша таблица пользователей (`users`) должна содержать колонку `remember_token` которая будет использована для хранения токена.

	if (Auth::attempt(['email' => $email, 'password' => $password], $remember)) {
		// Пользователь запомнен...
	}

Если вы используете механизм "Запоминания" пользователя, то вам необходимо использовать метод `viaRemember` для определения был ли пользователь залогинен этим способом.

	if (Auth::viaRemember()) {
		//
	}

#### Аутентификация пользователя по ID

Для аутентификации пользователя по ID используйте метод `loginUsingId`:

	Auth::loginUsingId(1);

#### Проверка прав пользователя без аутентификации

Метод `validate` позволяет проверить права пользователя без фактической аутентификации:

	if (Auth::validate($credentials)) {
		//
	}

#### Одноразовая аутентификация (на время выполнения текущего запроса)

Метод `once` используется для аутентификация пользователя на время выполнения текущего запроса. Сессия и куки использоваться не будут:

	if (Auth::once($credentials)) {
		//
	}

#### Ручная аутентификация пользователя

Если вам необходима принудительная аутентификация, то вы можете использовать метод `login` с экземпляром пользователя:

	Auth::login($user);

Это эквивалентно аутентификации с использованием метода `attempt` и передачей параметров пользователя.

#### Выход из приложения

	Auth::logout();
